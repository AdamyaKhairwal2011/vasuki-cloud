<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Guppt | Vasuki iTech Cloud</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
  /* Heading Typography */
  @font-face {
    font-family: 'VasukiCustom';
    src: url('custom.ttf') format('truetype');
    font-display: swap;
  }

  :root {
    --brand-gold: #bd8317;
    --brand-gold-dark: #332818;
    --text-main: #3c4043;
    --text-light: #70757a;
    --border: #dadce0;
    --bg-white: #ffffff;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Inter', sans-serif; background: var(--bg-white); color: var(--text-main); overflow-x: hidden; }

  /* Interactive Background */
  #hero-wrap {
    position: relative;
    height: 60vh;
    min-height: 400px;
    background: linear-gradient(to bottom, #745d3c, #5a462a);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    text-align: center;
    z-index: 1;
  }

  #dotCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }

  nav {
    position: absolute;
    top: 0; width: 100%;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 5%;
    z-index: 10;
  }
  .logo { font-family: 'VasukiCustom', sans-serif; font-size: 24px; color: white; text-decoration: none; }

  /* Hero Content */
  .hero-title { 
    font-family: 'VasukiCustom', sans-serif; 
    font-size: clamp(28px, 7vw, 64px); 
    line-height: 1.1; margin-bottom: 20px; padding: 0 20px;
  }
  .hero-p { font-size: 16px; opacity: 0.8; margin-bottom: 30px; padding: 0 20px; max-width: 600px; }

  .btn-primary-lux {
    background: var(--brand-gold-dark);
    color: white; padding: 14px 32px; border-radius: 50px;
    text-decoration: none; font-weight: 500; font-size: 15px;
    transition: 0.3s; border: none; cursor: pointer;
    display: inline-flex; align-items: center; gap: 8px;
  }

  /* Dashboard Section */
  .section-card {
    max-width: 1000px;
    width: 92%;
    margin: -40px auto 100px;
    background: white;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    position: relative;
    z-index: 5;
  }

  .login-card { max-width: 400px; text-align: center; }

  /* Vault UI */
  .vault-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
  .vault-header h2 { font-family: 'VasukiCustom', sans-serif; font-size: clamp(22px, 5vw, 32px); }

  .add-secret-bar {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 12px;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 30px;
    border: 1px solid var(--border);
  }

  input { width: 100%; padding: 12px 16px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; outline: none; }
  input:focus { border-color: var(--brand-gold); }

  /* MPIN OVERLAY */
  #mpin-screen {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(15px);
    z-index: 10000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .mpin-container { display: flex; gap: 10px; margin: 25px 0; }
  .mpin-input { 
    width: clamp(45px, 12vw, 55px); height: 60px; text-align: center; font-size: 24px; 
    border-radius: 8px; border: 1px solid var(--border); background: white;
  }

  /* Secret Rows Responsive */
  .secret-row {
    display: grid;
    grid-template-columns: 1.5fr 1.5fr 44px 44px 44px;
    gap: 8px; padding: 12px;
    border-bottom: 1px solid #f0f0f0;
    align-items: center;
  }

  .icon-btn { 
    background: none; border: none; cursor: pointer; color: var(--text-light); 
    height: 40px; width: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
  }
  .icon-btn:hover { background: #eee; color: var(--brand-gold); }

  /* MOBILE FIXES */
  @media (max-width: 768px) {
    nav { padding: 0 20px; }
    .section-card { padding: 20px; margin-top: -30px; }
    
    .add-secret-bar {
      grid-template-columns: 1fr;
    }
    
    .secret-row {
      grid-template-columns: 1fr 1fr; /* Stack inputs */
      padding: 15px 0;
    }
    
    .secret-row input:nth-child(1),
    .secret-row input:nth-child(2) {
      grid-column: span 1;
    }
    
    .secret-row .icon-btn {
      grid-row: 2; /* Move buttons to second row */
      margin-top: 5px;
      justify-self: center;
    }
    
    .btn-del { justify-self: end !important; }
  }

  #toast-wrap { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 10001; }
  .toast { background: #1a1a1a; color: white; padding: 12px 20px; border-radius: 8px; margin-top: 10px; font-size: 13px; text-align: center; }
  .hidden { display: none !important; }
</style>
</head>
<body>

<div id="toast-wrap"></div>

<div id="mpin-screen">
  <h2 style="font-family: 'VasukiCustom'; font-size: 24px;" id="mpin-title">Vault Security</h2>
  <p style="color: var(--text-light); font-size: 14px;" id="mpin-subtitle">Enter your 4-digit code</p>
  <div class="mpin-container">
    <input type="password" inputmode="numeric" maxlength="1" class="mpin-input" id="m1">
    <input type="password" inputmode="numeric" maxlength="1" class="mpin-input" id="m2">
    <input type="password" inputmode="numeric" maxlength="1" class="mpin-input" id="m3">
    <input type="password" inputmode="numeric" maxlength="1" class="mpin-input" id="m4">
  </div>
  <button class="btn-primary-lux" onclick="validateMPIN()" style="width: 200px; justify-content: center;">Unlock</button>
  <span class="forgot-mpin" style="margin-top:20px; cursor:pointer; font-size:13px; color:var(--text-light); text-decoration:underline;" onclick="forgotMPIN()">Forgot MPIN?</span>
</div>

<nav id="mainNav">
  <a href="#" class="logo" id="navLogo">Vasuki Guppt</a>
</nav> <br><br><br>

<div id="landingView">
  <div id="hero-wrap">
    <canvas id="dotCanvas"></canvas>
    <div id="hero-content">
      <h1 class="hero-title">Manage Your Passwords<br>On The Cloud</h1>
      <p class="hero-p">Encrypted real-time secret keys management system</p>
      <button class="btn-primary-lux" onclick="document.getElementById('emailField').focus()">Access Secrets</button>
    </div>
  </div>

  <div id="loginSection" class="section-card login-card">
    <h2 style="font-family: 'VasukiCustom'; margin-bottom: 5px;">Sign In</h2>
    <p style="color: var(--text-light); margin-bottom: 25px; font-size: 13px;">Enter Master Credentials</p>
    <input id="emailField" type="email" placeholder="Email"><br><br>
    <input id="passwordField" type="password" placeholder="Password"><br><br>
    <button class="btn-primary-lux" style="width: 100%; justify-content: center;" id="loginBtn" onclick="login()">Enter Vault</button>
  </div>
</div>

<div id="dashboardSection" class="section-card hidden">
  <div class="vault-header">
    <h2>Secure Vault</h2>
    <button class="icon-btn" onclick="exportJSON()">
       <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
    </button>
  </div>

  <div class="add-secret-bar">
    <input id="newKey" placeholder="Identifier">
    <input id="newValue" placeholder="Secret" type="password">
    <button class="btn-primary-lux" style="justify-content: center;" onclick="addSecret()">Add</button>
  </div>

  <div id="vaultList"></div>
  <center style="margin-top: 40px;">
    <button class="btn-primary-lux" style="background:transparent; color: var(--text-light); border: 1px solid var(--border); font-size: 13px;" onclick="location.reload()">Logout</button>
  </center>
</div>

<script type="module">
// ... [Existing Supabase and Logic Script Stays the same as your previous code] ...
// Note: Ensure your script logic is appended here.
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://aitckloahlwemlekaour.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpdGNrbG9haGx3ZW1sZWthb3VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyOTQ3MTMsImV4cCI6MjA3MTg3MDcxM30.uQjQLSz0mQuuArPQ_F8u-suQ-6T0e9bF11ahQtSw6yA";
const API_BASE = "https://vasuki-cloud-backend-production.up.railway.app";
const PATH = "user_config_vasuki/Guppt.json";
const SECRET_KEY = "VASUKI_Guppt_MASTER_KEY_2025";
const DOMAIN = "https://vasuki.cloud/guppt/";

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
let currentUser = "";
let vaultData = {};
let isSettingMPIN = false;

/* MPIN UI HANDLERS */
const mpinInputs = document.querySelectorAll('.mpin-input');
mpinInputs.forEach((input, index) => {
  input.addEventListener('keyup', (e) => {
    if (e.key >= 0 && e.key <= 9) {
      if (index < 3) mpinInputs[index + 1].focus();
    } else if (e.key === 'Backspace') {
      if (index > 0) mpinInputs[index - 1].focus();
    }
  });
});

window.addEventListener('DOMContentLoaded', () => {
    const savedMPIN = localStorage.getItem('vcloud_mpin');
    const savedUser = localStorage.getItem('vcloud_user');
    if (savedMPIN && savedUser) {
        currentUser = savedUser;
        document.getElementById('mpin-screen').style.display = 'flex';
        mpinInputs[0].focus();
    }
    initParticles();
});

window.validateMPIN = function() {
    let pin = "";
    mpinInputs.forEach(i => pin += i.value);
    if(pin.length < 4) return notify("Enter 4 digits");

    if(isSettingMPIN) {
        localStorage.setItem('vcloud_mpin', pin);
        localStorage.setItem('vcloud_user', currentUser);
        enterDashboard();
    } else {
        if(pin === localStorage.getItem('vcloud_mpin')) {
            enterDashboard();
        } else {
            notify("Incorrect MPIN");
            mpinInputs.forEach(i => i.value = "");
            mpinInputs[0].focus();
        }
    }
};

window.forgotMPIN = function() {
    document.getElementById('mpin-screen').style.display = 'none';
    notify("Use Master Login");
};

function enterDashboard() {
    document.getElementById('mpin-screen').style.display = 'none';
    document.getElementById("landingView").classList.add("hidden");
    document.getElementById("navLogo").style.color = "var(--brand-gold)";
    document.getElementById("mainNav").style.position = "relative";
    document.getElementById("dashboardSection").classList.remove("hidden");
    document.getElementById("dashboardSection").classList.add("active");
    loadVault();
}

window.login = async function(){
  const e = document.getElementById("emailField").value.trim().toLowerCase();
  const p = document.getElementById("passwordField").value;
  const btn = document.getElementById("loginBtn");
  if(!e || !p) return notify("Enter credentials");
  
  btn.innerText = "Verifying...";
  const { data } = await supabase.from("users").select("*");
  const user = data?.find(u => u.username.toLowerCase() === e && u.password === p);

  if(user){
    currentUser = e;
    const hasMPIN = localStorage.getItem('vcloud_mpin');
    if(!hasMPIN) {
        isSettingMPIN = true;
        document.getElementById('mpin-title').innerText = "Setup MPIN";
        document.getElementById('mpin-screen').style.display = 'flex';
        mpinInputs[0].focus();
    } else { enterDashboard(); }
  } else {
    notify("Auth Failed");
    btn.innerText = "Enter Vault";
  }
};

function notify(msg) {
  const wrap = document.getElementById('toast-wrap');
  const t = document.createElement('div'); t.className='toast'; t.textContent=msg;
  wrap.appendChild(t);
  setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(), 400); }, 3000);
}

// ... Rest of Vault Sync/Render Logic ...
async function getCryptoKey(){
  const hash = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(SECRET_KEY));
  return crypto.subtle.importKey("raw", hash, "AES-GCM", false, ["encrypt","decrypt"]);
}
async function encrypt(text){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await getCryptoKey();
  const enc = await crypto.subtle.encrypt({name:"AES-GCM",iv}, key, new TextEncoder().encode(text));
  return btoa(String.fromCharCode(...iv))+"."+btoa(String.fromCharCode(...new Uint8Array(enc)));
}
async function decrypt(data){
  try {
    const [ivB, encB] = data.split(".");
    const iv = Uint8Array.from(atob(ivB), c=>c.charCodeAt(0));
    const enc = Uint8Array.from(atob(encB), c=>c.charCodeAt(0));
    const key = await getCryptoKey();
    const dec = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, enc);
    return new TextDecoder().decode(dec);
  } catch(e) { return "{}"; }
}

async function loadVault(){
  const r = await fetch(API_BASE+"/get-file-content", {
    method:"POST", headers:{"Content-Type":"application/json"}, 
    body:JSON.stringify({email: currentUser, path:PATH})
  });
  const res = await r.json();
  if(res.content) vaultData = JSON.parse(await decrypt(res.content));
  renderVault();
}

async function syncVault(){
  const enc = await encrypt(JSON.stringify(vaultData));
  await fetch(API_BASE+"/save-file-content", {
    method:"POST", headers:{"Content-Type":"application/json"}, 
    body:JSON.stringify({email: currentUser, path:PATH, content:enc})
  });
  notify("Vault Synced");
  renderVault();
}

function renderVault(){
  const list = document.getElementById("vaultList");
  list.innerHTML = "";
  Object.keys(vaultData).forEach(key => {
    const val = vaultData[key]?.value || vaultData[key];
    const row = document.createElement("div");
    row.className = "secret-row";
    row.innerHTML = `
      <input value="${key}" id="k-${key}">
      <input value="${val}" type="password" id="v-${key}" onfocus="this.type='text'" onblur="this.type='password'">
      <button class="icon-btn" onclick="updateSecret('${key}')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg></button>
      <button class="icon-btn" onclick="copyApi('${key}')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
      <button class="icon-btn btn-del" onclick="deleteSecret('${key}')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg></button>
    `;
    list.appendChild(row);
  });
}

window.addSecret = () => {
  const k = document.getElementById("newKey").value.trim();
  const v = document.getElementById("newValue").value;
  if(k) { vaultData[k] = { value: v }; syncVault(); }
};

window.updateSecret = (oldKey) => {
  const newK = document.getElementById(`k-${oldKey}`).value;
  const newV = document.getElementById(`v-${oldKey}`).value;
  delete vaultData[oldKey]; vaultData[newK] = { value: newV };
  syncVault();
};

window.deleteSecret = (k) => { if(confirm(`Delete ${k}?`)) { delete vaultData[k]; syncVault(); } };

window.copyApi = (k) => {
  navigator.clipboard.writeText(`${DOMAIN}?email=${encodeURIComponent(currentUser)}&key=${encodeURIComponent(k)}`);
  notify("Link Copied");
};

window.exportJSON = () => {
  navigator.clipboard.writeText(JSON.stringify(vaultData, null, 2));
  notify("JSON Copied");
};

/* Particle Engine */
const canvas = document.getElementById('dotCanvas');
const ctx = canvas.getContext('2d');
let dots = [];
function initParticles() {
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  dots = [];
  for(let i=0; i<50; i++) dots.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, r: 1});
}
function animate() {
  ctx.clearRect(0,0,canvas.width, canvas.height);
  ctx.fillStyle = "rgba(255,255,255,0.3)";
  dots.forEach(d => {
    ctx.beginPath(); ctx.arc(d.x, d.y, d.r, 0, Math.PI*2); ctx.fill();
    d.y -= 0.2; if(d.y < 0) d.y = canvas.height;
  });
  requestAnimationFrame(animate);
}
animate();
</script>
</body>
</html>
