<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Vasuki Forms</title>

<style>
:root{
  --bg:#f0ebf8;
  --card:#fff;
  --primary:#253c68;
  --text:#202124;
  --text-secondary:#70757a;
  --border:#dadce0;
}
*{box-sizing:border-box}
body{
  font-family:Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  margin:0;
  padding:20px 10px;
  display:flex;
  justify-content:center;
  color:var(--text);
}
.container{width:100%;max-width:640px}
.form-card{
  background:var(--card);
  border-radius:8px;
  border:1px solid var(--border);
  padding:24px;
  margin-bottom:12px;
}
.form-header{border-top:10px solid var(--primary)}
h1{margin:0 0 10px;font-size:32px}
.description{color:var(--text-secondary)}
.required-notice{color:#d93025;font-size:14px}
.field-group{
  margin-bottom:24px;
  padding:20px;
  border:1px solid var(--border);
  border-radius:8px;
  background-color: var(--card);
}
.field-label{
  display:block;
  font-size:16px;
  font-weight:500;
  margin-bottom:15px;
}
.input-text,.input-textarea,.input-select{
  width:100%;
  border:none;
  border-bottom:1px solid var(--border);
  padding:8px 0;
  outline:none;
  font-size:14px;
}
.input-text:focus,.input-textarea:focus{
  border-bottom:2px solid var(--primary);
}
.option-item{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
  cursor:pointer;
}
.btn-submit{
  background:var(--primary);
  color:#fff;
  padding:10px 24px;
  border:none;
  border-radius:4px;
  cursor:pointer;
}
.btn-submit:hover{background:#512da8}
#loading{text-align:center;padding:50px;font-weight:500}
.error-msg{color:#d93025;text-align:center;margin-top:50px}
</style>
</head>

<body>
<div class="container">
  <div id="loading">Loading form...</div>

  <div id="form-container" style="display:none">
    <form id="publicForm">
      <div class="form-card form-header">
        <h1 id="displayTitle">Untitled Form</h1>
        <div class="description">Submit your response via Vasuki Cloud ATN.</div>
        <div class="required-notice">* Indicates required question</div>
      </div>

      <div id="fieldsList"></div>

      <div style="display:flex;justify-content:space-between;align-items:center">
        <button type="submit" class="btn-submit">Submit</button>
        <button type="button" onclick="location.reload()"
          style="background:none;border:none;color:var(--text-secondary);cursor:pointer">
          Clear form
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ====================== SCRIPT ====================== -->
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";



window.supabase = createClient(
  "https://aitckloahlwemlekaour.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpdGNrbG9haGx3ZW1sZWthb3VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyOTQ3MTMsImV4cCI6MjA3MTg3MDcxM30.uQjQLSz0mQuuArPQ_F8u-suQ-6T0e9bF11ahQtSw6yA"
);

/* ---------- URL ---------- */
const params = new URLSearchParams(location.search);
const formId = params.get("id");
let currentFields = [];

/* ---------- LOAD FORM ---------- */
async function loadForm(){
  if(!formId){
    document.body.innerHTML='<h2 class="error-msg">Invalid Form Link</h2>';
    return;
  }

  try{
    const {data,error} = await supabase
      .from("forms")
      .select("*")
      .eq("id",formId)
      .single();

    if(error || !data) throw error;
    renderForm(data);

  }catch(e){
    console.error(e);
    document.body.innerHTML='<h2 class="error-msg">Form not found.</h2>';
  }
}

/* ---------- RENDER ---------- */
function renderForm(form){
  document.getElementById("loading").style.display="none";
  document.getElementById("form-container").style.display="block";
  document.getElementById("displayTitle").textContent=form.title;

  currentFields=form.fields||[];
  const wrap=document.getElementById("fieldsList");

  wrap.innerHTML=currentFields.map(f=>{
    let input="";
    const req=f.required?'required':'';

    switch(f.type){
      case "textarea":
        input=`<textarea class="input-textarea" name="${f.id}" rows="3" ${req}></textarea>`;
        break;

      case "select":
        input=`<select class="input-select" name="${f.id}" ${req}>
          <option value="">Choose</option>
          ${f.options.map(o=>`<option value="${o}">${o}</option>`).join("")}
        </select>`;
        break;

      case "radio":
        input=f.options.map(o=>`
          <label class="option-item">
            <input type="radio" name="${f.id}" value="${o}" ${req}>
            <span>${o}</span>
          </label>`).join("");
        break;

      case "checkbox":
        input=f.options.map(o=>`
          <label class="option-item">
            <input type="checkbox" name="${f.id}" value="${o}">
            <span>${o}</span>
          </label>`).join("");
        break;

      default:
        input=`<input class="input-text" type="${f.type}" name="${f.id}" ${req}>`;
    }

    return`
      <div class="field-group">
        <label class="field-label">
          ${f.label} ${f.required?'<span style="color:red">*</span>':''}
        </label>
        ${input}
      </div>`;
  }).join("");
}

/* ---------- SUBMIT ---------- */
document.getElementById("publicForm").addEventListener("submit",async e=>{
  e.preventDefault();

  /* checkbox required validation */
  for(const f of currentFields){
    if(f.required && f.type==="checkbox"){
      const checked=document.querySelectorAll(`input[name="${f.id}"]:checked`);
      if(!checked.length){
        alert(`Please select at least one option for "${f.label}"`);
        return;
      }
    }
  }

  const fd=new FormData(e.target);
  const payload={};

  fd.forEach((v,k)=>{
    if(payload[k]){
      if(!Array.isArray(payload[k])) payload[k]=[payload[k]];
      payload[k].push(v);
    }else payload[k]=v;
  });

  try{
    const {error}=await supabase
      .from("form_responses")
      .insert({
        form_id:formId,
        submission:payload,
        created_at:new Date().toISOString()
      });

    if(error) throw error;

    document.getElementById("form-container").innerHTML=`
      <div class="form-card">
        <h1>${document.getElementById("displayTitle").textContent}</h1>
        <p>Your response has been recorded.</p>
        <a href="#" onclick="location.reload()" style="color:var(--primary)">
          Submit another response
        </a>
      </div>`;
  }catch(err){
    alert("Submission failed: "+err.message);
  }
});

loadForm();
</script>
</body>
</html>

