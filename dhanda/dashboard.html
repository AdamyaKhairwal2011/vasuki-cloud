<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vasuki Admin Console</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --google-blue: #1a73e8;
      --google-blue-variant: #e8f0fe;
      --google-gray: #5f6368;
      --google-dark: #202124;
      --google-border: #dadce0;
      --surface: #ffffff;
      --bg-gradient: linear-gradient(135deg, #f8f9fa 0%, #e8eaed 100%);
      --radius-lg: 24px;
      --radius-md: 12px;
      --shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    textarea {
        min-height: min-content;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-gradient);
      color: var(--google-dark);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* --- Sophisticated Animations --- */
    @keyframes entrance {
      from { opacity: 0; transform: translateY(20px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .fade-in { animation: entrance 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

    /* --- Auth & Registration --- */
    #authView {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .auth-container { width: 100%; max-width: 480px; perspective: 1000px; }

    .auth-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      padding: 48px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255,255,255,0.4);
      box-shadow: 0 20px 50px rgba(0,0,0,0.1);
      text-align: center;
    }

    .drop-zone {
      border: 2px dashed var(--google-border);
      border-radius: var(--radius-md);
      padding: 40px 20px;
      margin: 24px 0;
      cursor: pointer;
      transition: var(--transition);
      background: rgba(255,255,255,0.5);
    }
    .drop-zone:hover, .drop-zone.dragover {
      border-color: var(--google-blue);
      background: var(--google-blue-variant);
    }

    /* --- App Layout --- */
    #mainApp {
      display: none;
      grid-template-columns: 280px 1fr;
      min-height: 100vh;
    }

    .sidebar {
      background: var(--surface);
      border-right: 1px solid var(--google-border);
      padding: 40px 0;
      display: flex;
      flex-direction: column;
      position: sticky;
      top: 0; height: 100vh;
    }

    .nav-item {
      padding: 14px 28px;
      margin: 4px 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      border-radius: 100px;
      font-weight: 500;
      color: var(--google-gray);
      transition: var(--transition);
    }
    .nav-item:hover { background: #f1f3f4; color: var(--google-dark); }
    .nav-item.active { background: var(--google-blue-variant); color: var(--google-blue); }

    .content-area {
      padding: 60px 80px;
      max-width: 1200px;
    }

    /* --- Modern Components --- */
    .card {
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 32px;
      margin-bottom: 32px;
      border: 1px solid var(--google-border);
      transition: var(--transition);
    }
    .card:hover { box-shadow: var(--shadow); }

    .google-input {
      width: 100%;
      padding: 14px 18px;
      border: 1px solid var(--google-border);
      border-radius: 8px;
      font-size: 15px;
      transition: var(--transition);
      background: #fdfdfd;
    }
    .google-input:focus {
      outline: none;
      border-color: var(--google-blue);
      box-shadow: 0 0 0 4px rgba(26,115,232,0.1);
    }

    .btn-google {
      background: var(--google-blue);
      color: white;
      border: none;
      padding: 12px 32px;
      border-radius: 100px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 12px;
      transition: var(--transition);
      box-shadow: 0 4px 6px rgba(26,115,232,0.2);
    }
    .btn-google:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(26,115,232,0.3); }

    .chip {
      background: #e8eaed;
      padding: 8px 16px;
      border-radius: 100px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 4px;
      font-size: 14px;
    }

    .loader {
      width: 20px; height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%; border-top-color: #fff;
      animation: spin 0.8s linear infinite;
    }

    .hidden { display: none !important; }

    @media (max-width: 900px) {
      #mainApp { grid-template-columns: 80px 1fr; }
      .nav-text, .sidebar-header { display: none; }
      .content-area { padding: 40px 20px; }
    }
  </style>
</head>
<body>

  <div id="authView">
    <div class="auth-container fade-in">
      
      <div class="auth-card" id="loginCard">
        <div style="margin-bottom: 24px;">
          <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--google-blue)" stroke-width="1.5"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
        </div>
        <h1 style="font-family:'Google Sans'; font-size: 28px; margin-bottom: 8px;">Vasuki iTech</h1>
        <p style="color: var(--google-gray); margin-bottom: 32px;">CEO Admin Console</p>
        
        <div class="drop-zone" id="dropZone" onclick="document.getElementById('authFileInput').click()">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#bdc1c6" stroke-width="2" style="margin-bottom:12px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          <p id="fileStatus" style="font-size: 14px; color: var(--google-gray);">Drop <b>startup.authenticator.vasuki</b></p>
          <input type="file" id="authFileInput" hidden accept=".vasuki">
        </div>

        <button class="btn-google" style="width: 100%; justify-content: center;" onclick="handleFileLogin()" id="loginBtn">
          <span id="loginBtnText">Authenticate Identity</span>
        </button>

        <p style="margin-top: 24px; font-size: 14px; color: var(--google-gray);">
          No credential file? <a href="javascript:void(0)" onclick="toggleAuth(true)" style="color: var(--google-blue); text-decoration: none; font-weight: 500;">Register Account</a>
        </p>
      </div>

      <div class="auth-card hidden" id="registerCard">
        <h1 style="font-family:'Google Sans'; font-size: 28px; margin-bottom: 32px;">New Console Access</h1>
        <input type="email" id="regEmail" class="google-input" placeholder="Work Email" style="margin-bottom: 16px;">
        <input type="password" id="regPass" class="google-input" placeholder="Secure Password" style="margin-bottom: 24px;">
        
        <button class="btn-google" style="width: 100%; justify-content: center;" onclick="handleRegistration()">
          Generate & Download Authenticator
        </button>

        <p style="margin-top: 24px; font-size: 14px; color: var(--google-gray);">
          Already have a file? <a href="javascript:void(0)" onclick="toggleAuth(false)" style="color: var(--google-blue); text-decoration: none; font-weight: 500;">Sign In</a>
        </p>
      </div>

    </div>
  </div>

  <div id="mainApp">
    <aside class="sidebar">
      <div class="sidebar-header" style="padding: 0 32px 48px; font-family: 'Google Sans'; font-size: 22px; font-weight: 500; color: var(--google-blue); display:flex; align-items:center; gap:12px;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
        Vasuki
      </div>
      
      <div class="nav-item active" onclick="switchView('editorView', 0)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        <span class="nav-text">Profile Editor</span>
      </div>
      
      <div class="nav-item" onclick="switchView('dashboardView', 1)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
        <span class="nav-text">Digital Presence</span>
      </div>

      <div style="margin-top: auto;">
        <div class="nav-item" onclick="location.reload()" style="color: #d93025;">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          <span class="nav-text">Logout</span>
        </div>
      </div>
    </aside>

    <main class="content-area">
      <div id="editorView" class="fade-in">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:48px;">
          <h1 style="font-family:'Google Sans'; font-size:32px;">Organization Profile</h1>
          <button class="btn-google" id="saveBtn" onclick="saveStartup()">
            <span id="saveBtnText">Save All Changes</span>
          </button>
        </div>

        <div class="card">
          <div style="display: flex; align-items: center; gap: 40px; margin-bottom: 40px;">
            <div style="position: relative;">
              <img id="logoPreview" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" style="width:120px; height:120px; border-radius:100px; object-fit:cover; border: 4px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.05);">
              <button class="btn-google" style="position:absolute; bottom:0; right:0; padding:8px; width:40px; height:40px; border-radius:50%;" onclick="document.getElementById('logoInput').click()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
              </button>
            </div>
            <div style="flex:1">
              <label style="display:block; font-size:14px; font-weight:500; color:var(--google-gray); margin-bottom:12px;">Brand Accent Color</label>
              <input type="color" id="themeColor" style="width:100%; height:44px; border:none; border-radius:8px; cursor:pointer;">
            </div>
            <input type="file" id="logoInput" hidden accept="image/*">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div>
              <label style="display:block; font-size:13px; font-weight:500; margin-bottom:8px;">Startup Name</label>
              <input id="startupName" class="google-input" placeholder="Vasuki iTech">
            </div>
            <div>
              <label style="display:block; font-size:13px; font-weight:500; margin-bottom:8px;">Tagline</label>
              <input id="startupTagline" class="google-input" placeholder="Accelerating the future...">
            </div>
          </div>

          <div>
            <label style="display:block; font-size:13px; font-weight:500; margin-bottom:8px;">Detailed Bio</label>
            <textarea id="startupAbout" class="google-input" rows="6" placeholder="Describe the company mission..."></textarea>
          </div>
        </div>

        <div class="card">
          <h3 style="font-family:'Google Sans'; margin-bottom:24px;">Contact Channels</h3>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <input id="contactEmail" class="google-input" placeholder="Support Email">
            <input id="contactPhone" class="google-input" placeholder="Business Phone">
            <input id="contactWebsite" class="google-input" placeholder="Official Website URL">
            <input id="contactLinkedIn" class="google-input" placeholder="LinkedIn Profile URL">
          </div>
        </div>

        <div class="card">
          <h3 style="font-family:'Google Sans'; margin-bottom:24px;">Interactive Quick Links</h3>
          <div style="display:flex; gap:12px; margin-bottom:20px;">
            <input id="btnLabel" class="google-input" placeholder="Label (e.g. Whitepaper)">
            <input id="btnUrl" class="google-input" placeholder="https://...">
            <button class="btn-google" onclick="addButton()">Add</button>
          </div>
          <div id="buttonList" style="min-height: 50px; border: 2px dashed #eee; border-radius: 8px; padding: 12px; display:flex; flex-wrap:wrap;"></div>
        </div>
      </div>

      <div id="dashboardView" class="hidden fade-in">
        <h1 style="font-family:'Google Sans'; font-size:32px; margin-bottom:48px;">Digital Presence</h1>
        <div id="startupContent"></div>
      </div>
    </main>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    window.supabase = createClient(
      "https://aitckloahlwemlekaour.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpdGNrbG9haGx3ZW1sZWthb3VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyOTQ3MTMsImV4cCI6MjA3MTg3MDcxM30.uQjQLSz0mQuuArPQ_F8u-suQ-6T0e9bF11ahQtSw6yA"
    );
  </script>

  <script>
    let currentStartup = null;
    let logoBase64 = '';
    let buttons = [];
    let USER_EMAIL = '';
    let uploadedAuthData = null;

    // --- Auth View Toggles ---
    function toggleAuth(isReg) {
      document.getElementById('loginCard').classList.toggle('hidden', isReg);
      document.getElementById('registerCard').classList.toggle('hidden', !isReg);
    }

    // --- File-Based Auth Logic ---
    const dropZone = document.getElementById('dropZone');
    const authInput = document.getElementById('authFileInput');

    authInput.onchange = (e) => processFile(e.target.files[0]);
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = (e) => { e.preventDefault(); processFile(e.dataTransfer.files[0]); };

    function processFile(file) {
      if (!file || !file.name.endsWith('.vasuki')) return alert("Invalid authenticator file.");
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const decrypted = JSON.parse(atob(e.target.result));
          uploadedAuthData = decrypted;
          document.getElementById('fileStatus').innerHTML = `<b>Loaded:</b> ${file.name}`;
          document.getElementById('fileStatus').style.color = 'var(--google-blue)';
        } catch (err) { alert("File corrupted or invalid."); }
      };
      reader.readAsText(file);
    }

    async function handleFileLogin() {
      if (!uploadedAuthData) return alert("Please upload your .vasuki file first.");
      const btn = document.getElementById('loginBtn');
      const text = document.getElementById('loginBtnText');
      
      btn.disabled = true;
      text.innerHTML = '<div class="loader"></div>';

      // Simulation/Verification with Supabase
      USER_EMAIL = uploadedAuthData.email;
      const { data } = await supabase.from('startups').select('*').eq('email_owner', USER_EMAIL);
      
      setTimeout(() => {
        document.getElementById('authView').classList.add('hidden');
        document.getElementById('mainApp').style.display = 'grid';
        if(data && data[0]) populateEditor(data[0]);
        else loadStartupData(); // Fetch fresh
      }, 1000);
    }

    function handleRegistration() {
      const email = document.getElementById('regEmail').value;
      const pass = document.getElementById('regPass').value;
      if(!email || !pass) return alert("All fields are required.");

      const authObj = { email, pass: btoa(pass), created: new Date().toISOString() };
      const encoded = btoa(JSON.stringify(authObj));
      
      const blob = new Blob([encoded], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'startup.authenticator.vasuki';
      a.click();
      
      alert("Registration Successful! Use the downloaded file to login.");
      toggleAuth(false);
    }

    // --- UI Logic & Navigation ---
    function switchView(viewId, navIndex) {
      document.getElementById('editorView').classList.add('hidden');
      document.getElementById('dashboardView').classList.add('hidden');
      document.getElementById(viewId).classList.remove('hidden');
      document.querySelectorAll('.nav-item').forEach((item, i) => {
        item.classList.toggle('active', i === navIndex);
      });
      if(viewId === 'dashboardView') renderDashboard();
    }

    // --- Existing Data Logic (Maintained) ---
    async function loadStartupData() {
      const { data } = await supabase.from('startups').select('*').eq('email_owner', USER_EMAIL);
      if (data && data[0]) {
        currentStartup = data[0];
        populateEditor(currentStartup);
      }
    }

    function populateEditor(d) {
      currentStartup = d;
      logoBase64 = d.logo_base64 || '';
      buttons = d.buttons || [];
      document.getElementById('logoPreview').src = logoBase64 || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
      document.getElementById('themeColor').value = d.theme_color || '#1a73e8';
      document.getElementById('startupName').value = d.name || '';
      document.getElementById('startupTagline').value = d.tagline || '';
      document.getElementById('startupAbout').value = d.about || '';
      document.getElementById('contactEmail').value = d.contacts?.email || '';
      document.getElementById('contactPhone').value = d.contacts?.phone || '';
      document.getElementById('contactWebsite').value = d.contacts?.website || '';
      document.getElementById('contactLinkedIn').value = d.contacts?.linkedin || '';
      renderButtons();
    }

    async function saveStartup() {
      const btn = document.getElementById('saveBtn');
      const text = document.getElementById('saveBtnText');
      const name = document.getElementById('startupName').value;
      if(!name) return alert("Startup Name is required");

      btn.disabled = true;
      text.innerHTML = '<div class="loader"></div>';

      const payload = {
        name,
        tagline: document.getElementById('startupTagline').value,
        theme_color: document.getElementById('themeColor').value,
        about: document.getElementById('startupAbout').value,
        logo_base64: logoBase64,
        buttons: buttons,
        contacts: {
          email: document.getElementById('contactEmail').value,
          phone: document.getElementById('contactPhone').value,
          website: document.getElementById('contactWebsite').value,
          linkedin: document.getElementById('contactLinkedIn').value,
        },
        email_owner: USER_EMAIL
      };

      const q = supabase.from('startups');
      const res = currentStartup ? await q.update(payload).eq('id', currentStartup.id) : await q.insert([payload]);

      setTimeout(() => {
        btn.disabled = false;
        text.innerHTML = 'Save All Changes';
        if (!res.error) {
          alert("Cloud Sync Successful! ðŸš€");
          loadStartupData();
        }
      }, 800);
    }

    function renderButtons() {
      const list = document.getElementById('buttonList');
      if(buttons.length === 0) { list.innerHTML = '<p style="color:#999; font-size:12px;">No links added</p>'; return; }
      list.innerHTML = buttons.map((b, i) => `
        <div class="chip fade-in">
          <span>${b.label}</span>
          <span style="cursor:pointer; font-weight:bold;" onclick="removeButton(${i})">Ã—</span>
        </div>
      `).join('');
    }

    function addButton() {
      const label = document.getElementById('btnLabel').value;
      const url = document.getElementById('btnUrl').value;
      if(label && url) {
        buttons.push({label, url});
        renderButtons();
        document.getElementById('btnLabel').value = '';
        document.getElementById('btnUrl').value = '';
      }
    }

    function removeButton(i) { buttons.splice(i, 1); renderButtons(); }

    document.getElementById('logoInput').onchange = (e) => {
      const reader = new FileReader();
      reader.onload = () => {
        logoBase64 = reader.result;
        document.getElementById('logoPreview').src = logoBase64;
      };
      reader.readAsDataURL(e.target.files[0]);
    };

    function renderDashboard() {
      if (!currentStartup) {
        document.getElementById('startupContent').innerHTML = '<div class="card">Please save your profile first to activate dashboard.</div>';
        return;
      }
      const orgUrl = `https://www.vasuki.cloud/org.html?org=${currentStartup.id}`;
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(orgUrl)}`;
      
      document.getElementById('startupContent').innerHTML = `
        <div class="card" style="display:flex; gap:60px; align-items:center;">
          <div style="flex:1;">
            <h2 style="font-family:'Google Sans'; margin-bottom:12px;">${currentStartup.name}</h2>
            <p style="color:var(--google-gray); margin-bottom:24px;">Your public profile is live at:</p>
            <div style="background:#f8f9fa; padding:16px; border-radius:8px; font-family:monospace; margin-bottom:24px; border:1px solid #eee; word-break:break-all;">
              ${orgUrl}
            </div>
            <button class="btn-google" onclick="window.open('${orgUrl}', '_blank')">Launch Public View</button>
          </div>
          <div style="text-align:center; padding:24px; background:#fff; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.05);">
            <img src="${qrUrl}" style="border-radius:8px; margin-bottom:12px;">
            <p style="font-size:12px; color:var(--google-gray); font-weight:700; letter-spacing:1px;">IDENTITY QR</p>
          </div>
        </div>
      `;
    }

    document.addEventListener('contextmenu', e => e.preventDefault());
  </script>
</body>
</html>
